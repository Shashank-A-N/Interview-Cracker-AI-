<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Cracker AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom animation for fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Styles for the resizable split pane */
        .resizable-handle {
            width: 8px;
            cursor: col-resize;
            background-color: #e5e7eb;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .resizable-handle:hover {
            background-color: #94a3b8;
        }
        /* Success Animation Styles */
        @keyframes trophy-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .trophy-animation {
            animation: trophy-pop 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        /* Confetti Styles */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh);
                opacity: 0;
            }
        }
        /* Prose styles for markdown rendering */
        .prose {
            color: #374151;
            max-width: none;
        }
        .prose strong {
            font-weight: 600;
        }
        .prose code {
            background-color: #e5e7eb;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .prose pre {
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose ul {
            list-style-type: disc;
            list-style-position: inside;
            padding-left: 1rem;
        }
        .prose p, .prose ul, .prose h3 {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app"></div>

    <script type="module">
        // --- Icon SVGs (replaces lucide-react) ---
        const icons = {
            briefcase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
            cpu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="4" rx="2"/><rect width="6" height="6" x="9" y="9" rx="1"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            code: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
            userCheck: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>`,
            brainCircuit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2.5 2.5 0 0 1 3 4.83"/><path d="M12 2a2.5 2.5 0 0 0-3 4.83"/><path d="M12 20a2.5 2.5 0 0 1 3-4.83"/><path d="M12 20a2.5 2.5 0 0 0-3-4.83"/><path d="M5 16a2.5 2.5 0 0 1 3-4.83"/><path d="M5 16a2.5 2.5 0 0 0 3-4.83"/><path d="M19 16a2.5 2.5 0 0 1-3-4.83"/><path d="M19 16a2.5 2.5 0 0 0-3-4.83"/><path d="M5 8a2.5 2.5 0 0 1 3 4.83"/><path d="M5 8a2.5 2.5 0 0 0 3 4.83"/><path d="M19 8a2.5 2.5 0 0 1-3 4.83"/><path d="M19 8a2.5 2.5 0 0 0-3 4.83"/><circle cx="12" cy="12" r="3"/><path d="M12 2v3.5"/><path d="M12 20v-3.5"/><path d="M5 16H2"/><path d="M5 8H2"/><path d="M19 16h3"/><path d="M19 8h3"/></svg>`,
            bot: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`,
            send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>`,
            loader: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
            target: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            youtube: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 7.5 4 12 4s9.5 2 9.5 3 0 10 0 10c0 1-4.5 3-9.5 3s-9.5-2-9.5-3Z"/><path d="m10 15 5-3-5-3z"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
            xCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
            clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            play: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
            maximize: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>`,
            minimize: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>`,
            trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            lightbulb: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
            eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
        };

        // --- Global State and App Logic ---
        const app = document.getElementById('app');
        let timerInterval = null;
        const apiKey = "AIzaSyA-FfPzdQSAoWF40GaGQyhhU4X9QKDraKU"; // Your API Key

        let state = {
            selectedRound: 'aptitude',
            jobDescription: '',
            aiPlan: null,
            isLoading: false,
            error: null,
            practiceModal: { isOpen: false, topic: null, round: null },
            mockInterviewModal: { isOpen: false },
            projectTitle: '',
            projectDescription: '',
            projectQA: [],
            isGeneratingQA: false,
            // Practice Modal State
            testState: 'setup',
            numQuestions: 5,
            timerDuration: 15,
            timeLeft: null,
            questions: [],
            userAnswers: [],
            currentIndex: 0,
            currentSelection: null,
            userCode: '',
            preferredLanguages: ['javascript', 'python'],
            activeLanguage: 'javascript',
            testResults: { passed: 0, failed: 0, cases: [] },
            isSubmitting: false,
            isFullscreen: false,
            allTestsPassed: false,
            aptitudeFeedback: null,
            isFeedbackLoading: false,
            isSolutionVisible: false,
            codeExplanation: null,
            isExplanationLoading: false,
            showSolutionConfirm: false,
            // Mock Interview State
            interviewHistory: [],
            isWaitingForAI: false,
            userInterviewInput: '',
        };

        function setState(newState) {
            Object.assign(state, newState);
            render();
        }

        // --- Utility Functions ---
        function parseMarkdown(text) {
            if (!text) return '';
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre class="bg-gray-800 p-2 rounded my-2 text-white"><code>${p1.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`)
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^(#{1,6})\s*(.*$)/gm, (match, hashes, content) => `<h${hashes.length} class="font-bold mt-2">${content}</h${hashes.length}>`)
                .replace(/^- (.*$)/gm, '<ul><li>$1</li></ul>')
                .replace(/\n/g, '<br>')
                .replace(/<br><ul>/g, '<ul>')
                .replace(/<\/ul><br>/g, '</ul>');
        }

        // --- API Calls ---
        async function handleApiCall(apiUrl, payload, errorMessagePrefix) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    const message = errorBody?.error?.message || `Request failed with status ${response.status}`;
                    throw new Error(message);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error("Invalid response structure from API.");
                }
            } catch (e) {
                console.error(`${errorMessagePrefix}:`, e);
                throw e;
            }
        }

        async function handleGeneratePlan() {
            if (!state.jobDescription.trim()) {
                setState({ error: "Please paste a job description first." });
                return;
            }
            setState({ isLoading: true, error: null, aiPlan: null });
            const prompt = `
                Analyze the following job description and create a comprehensive interview preparation plan. 
                If the input is short and seems like a job title (e.g., "Python Developer"), generate a detailed plan for a typical role with that title.
                Structure the output as a JSON object.
                The JSON object must have the following keys: "title", "keySkills", "aptitude", "coding", "technical", "behavioral", "gd_topics", and "roadmapAndResources".

                - "title": The job title.
                - "keySkills": An array of important skills.
                - "aptitude": An array of 3-5 aptitude topics.
                - "coding": An array of 3-5 coding problem types.
                - "technical": An array of 5-7 technical questions.
                - "behavioral": An array of 5-7 behavioral questions.
                - "gd_topics": An array of 3-5 Group Discussion topics.
                - "roadmapAndResources": An object with "roadmap" (a step-by-step plan as a string with \\n for newlines) and "youtubeLinks" (an array of {title, url} objects).
                
                Job Description/Title:
                ---
                ${state.jobDescription}
                ---
            `;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const text = await handleApiCall(apiUrl, payload, "Error generating plan");
                const parsedPlan = JSON.parse(text);
                if (parsedPlan && parsedPlan.title) {
                    setState({ aiPlan: parsedPlan, isLoading: false });
                } else {
                    throw new Error("Received an invalid or empty plan from the AI.");
                }
            } catch (e) {
                setState({ error: `Sorry, I couldn't generate the plan: ${e.message}`, isLoading: false });
            }
        }

        async function handleGenerateProjectQA() {
             if (!state.projectTitle.trim() || !state.projectDescription.trim()) return;
            setState({ isGeneratingQA: true, projectQA: [] });
            const prompt = `Act as a senior technical interviewer. Based on the project title and description, generate 5 insightful questions. Provide plain text answers.`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { question: { type: "STRING" }, elaboratedAnswerGuideline: { type: "STRING" } }, required: ["question", "elaboratedAnswerGuideline"] } };
            const payload = { contents: [{ role: "user", parts: [{ text: prompt + `\nTitle: ${state.projectTitle}\nDescription: ${state.projectDescription}` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const text = await handleApiCall(apiUrl, payload, "Error generating project questions");
                setState({ projectQA: JSON.parse(text), isGeneratingQA: false });
            } catch (e) {
                setState({ isGeneratingQA: false });
            }
        }
        
        async function getAptitudeFeedback() {
            setState({ isFeedbackLoading: true, aptitudeFeedback: null });
            const incorrectAnswers = state.userAnswers.filter(a => !a.isCorrect);
            if (incorrectAnswers.length === 0) {
                 setState({ isFeedbackLoading: false, aptitudeFeedback: "Excellent work! You answered all questions correctly. Keep practicing to maintain your skills." });
                 return;
            }

            const analysisPrompt = `A user took an aptitude test and made some mistakes. Analyze the following incorrect answers and provide personalized, actionable feedback as plain text bullet points.
                Incorrectly Answered Questions:
                ${incorrectAnswers.map(ua => `- Question: "${ua.question.question}"`).join('\n')}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: analysisPrompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const feedback = await handleApiCall(apiUrl, payload, "Error getting feedback");
                setState({ aptitudeFeedback: feedback, isFeedbackLoading: false });
            } catch (e) {
                setState({ isFeedbackLoading: false, aptitudeFeedback: "Could not load feedback at this time." });
            }
        }

        async function getCodeExplanation() {
            setState({ isExplanationLoading: true, codeExplanation: null });
            const problem = state.questions[state.currentIndex];
            const solution = problem.solutions[state.activeLanguage];
            const prompt = `
                Provide a clear, step-by-step explanation for the following code solution. Use markdown for formatting.
                The explanation should cover:
                1.  **Overall Approach:** Briefly describe the algorithm or technique used.
                2.  **Logic Breakdown:** Explain the key parts of the code.
                3.  **Time Complexity:** State the time complexity (e.g., O(n)).
                4.  **Space Complexity:** State the space complexity (e.g., O(1)).

                **Language:** ${state.activeLanguage}
                **Problem:** ${problem.title}
                **Solution Code:**
                \`\`\`
                ${solution}
                \`\`\`
            `;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const explanation = await handleApiCall(apiUrl, payload, "Error getting explanation");
                setState({ codeExplanation: explanation, isExplanationLoading: false });
            } catch (e) {
                setState({ isExplanationLoading: false, codeExplanation: "Could not load explanation." });
            }
        }
        
        async function getNextInterviewResponse() {
            setState({ isWaitingForAI: true });
            const history = state.interviewHistory.map(turn => `${turn.speaker}: ${turn.text}`).join('\n');
            const prompt = `
                You are an expert HR interviewer conducting a mock interview.
                Your personality is professional, encouraging, and insightful.
                Based on the conversation history, provide two things in your response:
                1.  **Feedback:** Give brief, constructive feedback on the user's last answer. Mention what was good and what could be improved (e.g., "That's a good start. To make it stronger, you could try using the STAR method...").
                2.  **Next Question:** Ask a relevant follow-up question or a new standard HR question.

                **Conversation History:**
                ${history}

                **Your Response (as plain text):**
            `;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const text = await handleApiCall(apiUrl, payload, "Error getting interview response");
                state.interviewHistory.push({ speaker: 'AI', text });
                setState({ isWaitingForAI: false });
            } catch (e) {
                state.interviewHistory.push({ speaker: 'AI', text: "I'm having a little trouble connecting. Could you please repeat your answer?" });
                setState({ isWaitingForAI: false });
            }
        }


        // --- Reusable Component Functions ---
        function Button({ onClick, disabled, children, variant = 'primary', className = '' }) {
            const baseClasses = "inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:cursor-not-allowed";
            const variants = {
                primary: "text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300",
                secondary: "text-gray-700 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100",
            };
            return `<button onclick="${onClick}" ${disabled ? 'disabled' : ''} class="${baseClasses} ${variants[variant]} ${className}">${children}</button>`;
        }

        // --- Main Component Rendering Functions ---
        function AIPlanDisplay() {
            if (state.isLoading && !state.aiPlan) return `<div class="flex flex-col items-center justify-center p-10 bg-white rounded-lg shadow-md"><div class="w-16 h-16 text-indigo-500 animate-bounce">${icons.bot}</div><p class="mt-4 text-lg font-semibold text-gray-700">AI is crafting your personalized plan...</p></div>`;
            if (state.error) return `<div class="p-10 bg-red-50 border border-red-200 rounded-lg shadow-md text-center"><p class="text-red-700 font-semibold">Oops! Something went wrong.</p><p class="text-red-600 mt-2">${state.error}</p></div>`;
            if (!state.aiPlan) return `<div class="flex flex-col items-center justify-center p-10 bg-white rounded-lg shadow-md text-center border-2 border-dashed border-gray-300"><div class="w-16 h-16 text-gray-400 mb-4">${icons.bot}</div><h3 class="text-xl font-bold text-gray-700">Your AI Prep Plan will appear here.</h3><p class="text-gray-500 mt-2">Paste a job description above and click "Generate Plan" to get started.</p></div>`;
            const renderSection = (title, items) => {
                if (!items || items.length === 0) return '';
                return `<div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-lg font-semibold text-gray-700 mb-3">${title}</h3><ul class="space-y-2">${items.map(item => `<li class="flex items-start"><div class="w-4 h-4 mr-2 mt-1 text-indigo-500 flex-shrink-0">${icons.target}</div><span class="text-gray-600">${item}</span></li>`).join('')}</ul></div>`;
            };
            const { roadmapAndResources } = state.aiPlan;
            return `<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg animate-fade-in space-y-6"><div><h2 class="text-2xl sm:text-3xl font-bold text-indigo-700">AI-Generated Prep Plan</h2><p class="text-xl font-semibold text-gray-800">${state.aiPlan.title || "For Your Next Role"}</p></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${renderSection("Key Skills to Master", state.aiPlan.keySkills)}${renderSection("Aptitude Focus Areas", state.aiPlan.aptitude)}${renderSection("Potential Coding Problems", state.aiPlan.coding)}${renderSection("Potential Technical Questions", state.aiPlan.technical)}${renderSection("Potential HR / Behavioral Questions", state.aiPlan.behavioral)}${renderSection("Possible Group Discussion Topics", state.aiPlan.gd_topics)}</div>${roadmapAndResources ? `<div class="bg-indigo-50 p-6 rounded-lg border border-indigo-200"><h3 class="text-xl font-bold text-indigo-800 mb-4">Your Personalized Roadmap & Resources</h3><div class="grid md:grid-cols-2 gap-8"><div><h4 class="font-semibold text-lg text-gray-700 mb-2">Preparation Roadmap</h4><div class="text-gray-600 prose prose-sm">${parseMarkdown(roadmapAndResources.roadmap)}</div></div><div><h4 class="font-semibold text-lg text-gray-700 mb-2">Recommended Videos</h4><ul class="space-y-3">${roadmapAndResources.youtubeLinks.map(link => `<li><a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 bg-white rounded-md shadow-sm hover:bg-gray-100 transition-colors group"><div class="w-6 h-6 mr-3 text-red-600 flex-shrink-0">${icons.youtube}</div><span class="text-indigo-700 group-hover:underline">${link.title}</span></a></li>`).join('')}</ul></div></div></div>` : ''}</div>`;
        }

        function RoundContent() {
            const roundId = state.selectedRound;
            const content = {
                aptitude: { title: "Aptitude Round", description: "This round is a critical filter, designed to test your raw problem-solving abilities, logical deduction, and verbal comprehension under pressure. Success here proves you have the foundational cognitive skills required for complex roles.", sections: [ { title: "Quantitative Aptitude", points: ["Percentages & Ratios", "Profit, Loss & Interest", "Time, Speed & Distance", "Permutations & Combinations", "Probability"] }, { title: "Logical Reasoning", points: ["Data Arrangements", "Blood Relations & Direction", "Syllogisms & Statements", "Coding-Decoding", "Data Sufficiency"] }, { title: "Verbal Ability", points: ["Reading Comprehension", "Grammar & Sentence Correction", "Vocabulary & Analogies", "Para Jumbles"] } ] },
                coding: { title: "Coding Round", description: "This is a direct evaluation of your core technical competency. You will be expected to write clean, efficient, and correct code for complex problems, demonstrating a strong grasp of data structures and algorithms.", sections: [ { title: "Core Data Structures", points: ["Arrays & Strings", "Linked Lists (All types)", "Stacks & Queues", "Trees (Binary, BST, Tries)", "Graphs (Traversal, Shortest Path)", "Hash Maps & Heaps"] }, { title: "Essential Algorithms", points: ["Advanced Sorting & Searching", "Recursion & Backtracking", "Dynamic Programming", "Greedy Algorithms", "Divide and Conquer"] } ] },
                gd: { title: "Group Discussion", description: "A high-stakes simulation of a team meeting, this round assesses your ability to articulate ideas, influence others, and collaborate towards a common goal under pressure. Leadership and communication skills are paramount.", sections: [ { title: "Key Assessment Areas", points: ["Clarity of Thought", "Assertiveness & Leadership", "Persuasion & Negotiation", "Group Dynamics Awareness", "Structured Argumentation"] }, { title: "Common Topics", points: ["Geopolitical Events & Policies", "Emerging Technologies (AI Ethics, etc.)", "Abstract & Philosophical Concepts", "Business Case Studies"] } ] },
                tech1: { title: "Technical Round 1", description: "This round verifies your theoretical foundation. Interviewers will probe your understanding of fundamental computer science principles to ensure you have the necessary knowledge to build upon.", sections: [ { title: "Key Subjects (CS/IT)", points: ["DBMS (Normalization, ACID, SQL)", "Operating Systems (Processes, Threads, Memory Mgmt)", "Computer Networks (OSI/TCP-IP, Protocols)", "Object-Oriented Programming (OOPs Pillars)"] }, { title: "Language Proficiency", points: ["In-depth language specifics (e.g., JVM, GIL)", "Memory Management", "Concurrency/Multithreading Concepts", "Standard Libraries"] } ] },
                tech2: { title: "Technical Round 2", description: "This is a deep-dive into your practical experience and system-level thinking. Be prepared to defend your technical decisions, discuss trade-offs, and architect solutions for complex, large-scale problems.", sections: [] },
                hr: { title: "HR Round", description: "This round assesses your alignment with the company's culture, values, and long-term vision. It's a crucial evaluation of your personality, motivation, and professional demeanor.", sections: [ { title: "Core Areas", points: ["Cultural Fit & Value Alignment", "Situational Judgement", "Career Goals & Ambition", "Salary & Expectation Negotiation", "Strengths, Weaknesses & Self-Awareness"] } ] },
                videos: { title: "Resource Video Library", description: "A curated library of high-quality videos to help you master key interview topics. Click any link to open the video in a new tab.", sections: [ { title: "Aptitude & Reasoning", links: [{ title: "Aptitude Tricks & Shortcuts (Full Course)", url: "https://www.youtube.com/watch?v=g_j_3_Nl-j0" }, { title: "Logical Reasoning Full Course", url: "https://www.youtube.com/watch?v=HkMNOlYcpHg" }] }, { title: "Data Structures & Algorithms", links: [{ title: "Complete DSA Roadmap", url: "https://www.youtube.com/watch?v=4I_1o_z2Lso" }, { title: "Big O Notation Explained", url: "https://www.youtube.com/watch?v=v4cd1O4zkGw" }, { title: "Dynamic Programming Patterns", url: "https://www.youtube.com/watch?v=oBt53YbR9Kk" }] }, { title: "System Design", links: [{ title: "System Design Fundamentals", url: "https://www.youtube.com/watch?v=i-1-a_qQh7s" }, { title: "Designing a URL Shortener", url: "https://www.youtube.com/watch?v=fQr4I-2gqHY" }] }, { title: "HR & Behavioral", links: [{ title: "How to Answer 'Tell Me About Yourself'", url: "https://www.youtube.com/watch?v=kayOhGRcNt4" }, { title: "Mastering the STAR Method", url: "https://www.youtube.com/watch?v=PucSSsPCKak" }] } ] }
            };
            const currentContent = content[roundId];
            if (!currentContent) return '';
            if (roundId === 'tech2') {
                return `<div class="bg-white p-6 sm:p-8 rounded-lg shadow-md animate-fade-in"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">${currentContent.title}</h2><p class="text-gray-600 mb-6">${currentContent.description}</p><div class="bg-gray-50 p-6 rounded-lg border space-y-4"><h3 class="text-xl font-semibold text-gray-700">AI Project Interrogator</h3><div><label for="projectTitle" class="block text-sm font-medium text-gray-700">Project Title</label><input type="text" id="projectTitle" value="${state.projectTitle}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" /></div><div><label for="projectDesc" class="block text-sm font-medium text-gray-700">Project Description</label><textarea id="projectDesc" rows="5" placeholder="Describe your project's architecture, tech stack, and key features..." class="mt-1 block w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">${state.projectDescription}</textarea></div>${Button({ onClick: 'handleGenerateProjectQA()', disabled: state.isGeneratingQA, children: state.isGeneratingQA ? `<span class="animate-spin mr-2 h-5 w-5">${icons.loader}</span>Generating Questions...` : 'Generate Project Questions', className: 'w-full' })}</div>${state.isGeneratingQA ? `<div class="text-center p-8"><div class="w-12 h-12 animate-spin text-indigo-600 mx-auto">${icons.loader}</div></div>` : ''}${state.projectQA.length > 0 ? `<div class="mt-8 space-y-6">${state.projectQA.map((item, index) => `<div class="bg-white p-4 rounded-lg border"><p class="font-semibold text-indigo-700 mb-2">${index + 1}. ${item.question}</p><div class="text-sm p-3 rounded bg-gray-50 text-gray-700"><p class="font-bold mb-1">Answering Strategy:</p><p class="whitespace-pre-wrap">${item.elaboratedAnswerGuideline}</p></div></div>`).join('')}</div>` : ''}</div>`;
            }
            if (roundId === 'videos') {
                 return `<div class="bg-white p-6 sm:p-8 rounded-lg shadow-md animate-fade-in"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">${currentContent.title}</h2><p class="text-gray-600 mb-6">${currentContent.description}</p><div class="grid md:grid-cols-2 gap-6">${currentContent.sections.map(section => `<div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-lg font-semibold text-gray-700 mb-3">${section.title}</h3><ul class="space-y-3">${section.links.map(link => `<li><a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 bg-white rounded-md shadow-sm hover:bg-gray-100 transition-colors group"><div class="w-6 h-6 mr-3 text-red-600 flex-shrink-0">${icons.youtube}</div><span class="text-indigo-700 group-hover:underline text-sm">${link.title}</span></a></li>`).join('')}</ul></div>`).join('')}</div></div>`;
            }
            return `<div class="bg-white p-6 sm:p-8 rounded-lg shadow-md animate-fade-in"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">${currentContent.title}</h2><p class="text-gray-600 mb-6">${currentContent.description}</p>${roundId === 'hr' ? `<div class="mt-6 mb-6">${Button({ onClick: `startMockInterview()`, children: `Start AI Mock Interview`, className: 'w-full !py-3 !text-base' })}</div>` : ''}<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${currentContent.sections.map(section => `<div class="bg-gray-50 p-4 rounded-lg border flex flex-col"><h3 class="text-lg font-semibold text-gray-700 mb-3">${section.title}</h3><ul class="space-y-2 flex-grow">${section.points.map(point => `<li class="flex items-start"><div class="w-4 h-4 mr-2 mt-1 text-indigo-500 flex-shrink-0">${icons.target}</div><span class="text-gray-600">${point}</span></li>`).join('')}</ul>${['aptitude', 'coding', 'tech1'].includes(roundId) ? Button({ onClick: `handleStartPractice(event, '${section.title}', '${roundId}')`, children: `Practice ${section.title}`, className: 'w-full mt-4' }) : ''}</div>`).join('')}</div></div>`;
        }
        
        // --- Practice Modal ---
        // Helper functions for rendering modal content
        const allLanguages = {
            javascript: { name: 'JavaScript', icon: 'https://raw.githubusercontent.com/devicons/devicon/master/icons/javascript/javascript-original.svg' },
            python: { name: 'Python', icon: 'https://raw.githubusercontent.com/devicons/devicon/master/icons/python/python-original.svg' },
            java: { name: 'Java', icon: 'https://raw.githubusercontent.com/devicons/devicon/master/icons/java/java-original.svg' },
            cpp: { name: 'C++', icon: 'https://raw.githubusercontent.com/devicons/devicon/master/icons/cplusplus/cplusplus-original.svg' },
        };

        function renderModalSetup(topic, round) {
            return `
                <div class="p-6 space-y-6">
                    <h3 class="text-xl font-bold text-gray-800">Practice Setup: ${topic}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="numQuestions" class="block text-sm font-medium text-gray-700">Number of Questions</label>
                            <input id="numQuestions" type="number" value="${state.numQuestions}" oninput="updatePracticeSetting('numQuestions', this.value)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <div>
                            <label for="timerDuration" class="block text-sm font-medium text-gray-700">Set Timer (minutes)</label>
                            <input id="timerDuration" type="number" value="${state.timerDuration}" oninput="updatePracticeSetting('timerDuration', this.value)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                    </div>
                    ${round === 'coding' ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Languages (min 1)</label>
                            <div class="flex flex-wrap gap-2 mt-1">
                                ${Object.entries(allLanguages).map(([key, value]) => `
                                    <button onclick="handleLanguageToggle('${key}')" class="flex items-center gap-2 p-2 rounded-md border-2 ${state.preferredLanguages.includes(key) ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}">
                                        <img src="${value.icon}" class="w-5 h-5" alt="${value.name}"/>
                                        <span class="text-sm">${value.name}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${state.error ? `<p class="text-red-600">${state.error}</p>` : ''}
                    ${Button({ onClick: 'handleStartTest()', disabled: state.isLoading || (round === 'coding' && state.preferredLanguages.length === 0), children: state.isLoading ? `<span class="animate-spin w-5 h-5 mr-2">${icons.loader}</span> Generating...` : "Start Practice", className: 'w-full' })}
                </div>
            `;
        }

        function renderModalCodingIDE() {
            const problem = state.questions[state.currentIndex];
            if (!problem) return `<div class="flex justify-center items-center h-full"><div class="w-12 h-12 animate-spin text-indigo-600">${icons.loader}</div></div>`;
            return `
                <div class="flex flex-col h-full ${state.isFullscreen ? 'fixed inset-0 bg-gray-100 z-50' : ''}" id="ide-container">
                    <div class="flex justify-between items-center p-2 border-b bg-gray-50 flex-shrink-0">
                        <h3 class="text-lg font-bold text-gray-800">${state.currentIndex + 1}. ${problem.title}</h3>
                        <div class="flex items-center space-x-4">
                            <div class="text-lg font-bold px-3 py-1 rounded-full flex items-center ${state.timeLeft <= 60 ? 'text-red-600 bg-red-100' : 'text-indigo-600 bg-indigo-100'}"><div class="w-5 h-5 mr-2">${icons.clock}</div> ${formatTime(state.timeLeft)}</div>
                            <button onclick="toggleFullscreen()" class="p-1 text-gray-600 hover:bg-gray-200 rounded-md">${state.isFullscreen ? icons.minimize : icons.maximize}</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-hidden flex flex-row" id="resizable-container">
                        <div id="problem-pane" class="bg-white p-4 overflow-y-auto h-full w-1/2">
                            <div class="prose prose-sm">${parseMarkdown(problem.problemStatement)}</div>
                        </div>
                        <div class="resizable-handle" id="resize-handle"></div>
                        <div id="editor-pane" class="flex flex-col bg-gray-800 overflow-hidden h-full flex-grow">
                            <div class="flex items-center justify-between bg-gray-900 p-2">
                                <div class="relative">
                                    <select id="language-select" class="bg-gray-700 text-white rounded-md pl-8 pr-4 py-1 text-sm appearance-none focus:outline-none">
                                        ${state.preferredLanguages.map(lang => `<option value="${lang}" ${state.activeLanguage === lang ? 'selected' : ''}>${allLanguages[lang].name}</option>`).join('')}
                                    </select>
                                    <img src="${allLanguages[state.activeLanguage]?.icon}" class="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2" alt="${allLanguages[state.activeLanguage]?.name}" />
                                </div>
                                ${Button({ onClick: 'confirmShowSolution()', variant: 'secondary', children: `<div class="w-4 h-4 mr-2">${icons.eye}</div> View Solution`, className: 'w-auto py-1 px-2 text-xs' })}
                            </div>
                            <textarea id="code-editor" class="flex-grow w-full bg-[#1e1e1e] text-gray-200 p-4 font-mono text-sm resize-none focus:outline-none" spellCheck="false">${state.userCode}</textarea>
                            <div class="bg-gray-900 p-2"><h4 class="text-white text-sm font-bold mb-2">Test Cases (${state.testResults.passed} / ${state.testResults.passed + state.testResults.failed})</h4>
                                <div class="max-h-28 overflow-y-auto">${state.testResults.cases.length > 0 ? state.testResults.cases.map((res, i) => `<div class="p-2 rounded-md mb-1 text-xs ${res.error ? 'bg-yellow-800/50' : res.passed ? 'bg-green-800/50' : 'bg-red-800/50'}">${res.error ? `<p class="font-bold text-yellow-300">${res.error}</p>` : `<p class="font-bold">Case ${i + 1}: ${res.passed ? 'Passed' : 'Failed'}</p><p>Input: ${res.input}, Expected: ${res.expectedOutput}, Got: ${res.actualOutput}</p>`}</div>`).join('') : `<p class="text-gray-400 text-xs">Run code to see results.</p>`}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-2 border-t bg-gray-50 space-x-2 flex-shrink-0">
                        ${Button({ onClick: 'handlePrevious()', variant: 'secondary', disabled: state.isSubmitting || state.currentIndex === 0, children: `<div class="w-4 h-4 mr-2">${icons.arrowLeft}</div> Previous`, className: 'w-auto' })}
                        <div class="flex space-x-2">
                            ${Button({ onClick: 'runCodeExecution()', variant: 'secondary', disabled: state.isSubmitting, children: `<div class="w-4 h-4 mr-2">${icons.play}</div> Run Code`, className: 'w-auto' })}
                            ${Button({ onClick: 'handleNext()', disabled: state.isSubmitting, children: state.currentIndex < state.questions.length - 1 ? 'Next Problem' : 'Finish Session', className: 'w-auto' })}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModalAptitudeTest() {
            const q = state.questions[state.currentIndex];
            if (!q) return '';
            return `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-lg font-semibold text-gray-800">Question ${state.currentIndex + 1} of ${state.questions.length}</p>
                        <div class="text-lg font-bold px-3 py-1 rounded-full flex items-center ${state.timeLeft <= 60 ? 'text-red-600 bg-red-100' : 'text-indigo-600 bg-indigo-100'}"><div class="w-5 h-5 mr-2">${icons.clock}</div> ${formatTime(state.timeLeft)}</div>
                    </div>
                    <p class="text-lg font-semibold text-gray-800 mb-4">${q.question}</p>
                    <div class="space-y-3">${q.options.map((option, index) => `<button onclick="setCurrentSelection(${index})" class="w-full text-left p-3 rounded-lg border-2 transition-all ${state.currentSelection === index ? 'border-indigo-500 bg-indigo-50' : 'bg-white border-gray-300 hover:border-indigo-400'}">${option}</button>`).join('')}</div>
                </div>
            `;
        }

        function renderModalResults(round) {
            const correctCount = state.userAnswers.filter(a => a.isCorrect).length;
            const score = state.userAnswers.length > 0 ? Math.round((correctCount / state.userAnswers.length) * 100) : 0;
            
            let feedbackContent = '';
            if (state.isFeedbackLoading) {
                feedbackContent = `<div class="flex items-center justify-center p-4"><div class="animate-spin w-6 h-6 mr-3">${icons.loader}</div><span>Analyzing your results...</span></div>`;
            } else if (state.aptitudeFeedback) {
                feedbackContent = `<div class="prose prose-sm max-w-none">${parseMarkdown(state.aptitudeFeedback)}</div>`;
            }

            return `
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-center text-gray-800">Test Complete!</h3>
                    ${round !== 'coding' ? `<div class="my-6 text-center"><p class="text-4xl font-bold text-green-600">${score}%</p><p>Correct</p></div>` : `<p class="text-center my-6">You've completed the coding session. Review your solutions and keep practicing!</p>`}
                    ${state.userAnswers.length > 0 ? `<div class="mt-6"><h4 class="text-xl font-semibold text-gray-800 mb-4">Answer Review</h4><div class="space-y-4 max-h-64 overflow-y-auto pr-2">${state.userAnswers.map((ua, index) => `<div class="bg-white p-4 rounded-lg border"><p class="font-semibold mb-2">${index + 1}. ${ua.question.question}</p><div class="text-sm p-2 rounded flex items-start ${ua.isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}"><div class="w-4 h-4 mr-2 mt-0.5">${ua.isCorrect ? icons.checkCircle : icons.xCircle}</div><span>Your answer: ${ua.answer !== null ? ua.question.options[ua.answer] : "Not answered"}</span></div><div class="text-sm p-2 mt-2 rounded bg-gray-100"><strong>Correct:</strong> ${ua.question.options[ua.question.correct_answer_index]}</div><div class="text-sm p-3 mt-2 rounded bg-blue-50 border border-blue-200 text-blue-800"><p class="font-bold mb-1">Explanation:</p><div class="prose prose-sm max-w-none">${parseMarkdown(ua.question.explanation)}</div></div></div>`).join('')}</div></div>` : ''}
                    ${round !== 'coding' ? `
                        <div class="mt-8">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><div class="w-5 h-5 mr-2 text-yellow-500">${icons.lightbulb}</div>Personalized Feedback</h4>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-r-lg">
                                ${feedbackContent}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderSuccessAnimation() {
            if (!state.allTestsPassed) return '';
            return `
                <div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col justify-center items-center z-50 animate-fade-in">
                    <div id="confetti-container" class="absolute inset-0 overflow-hidden"></div>
                    <div class="text-green-400 trophy-animation">${icons.trophy.replace('width="24"', 'width="128"').replace('height="24"', 'height="128"')}</div>
                    <h2 class="text-4xl font-bold text-white mt-4">All Tests Passed!</h2>
                    <p class="text-gray-300 mt-2">Moving to the next question...</p>
                </div>
            `;
        }

        function renderSolutionModal() {
            if (!state.isSolutionVisible) return '';
            let content = '';
            let title = 'Solution';

            if (state.isExplanationLoading) {
                content = `<div class="flex justify-center items-center p-8"><div class="animate-spin w-8 h-8 text-indigo-500">${icons.loader}</div></div>`;
                title = 'Generating Explanation...';
            } else if (state.codeExplanation) {
                content = `<div class="prose prose-sm p-4">${parseMarkdown(state.codeExplanation)}</div>`;
                title = 'AI Code Explanation';
            } else {
                const solution = state.questions[state.currentIndex].solutions[state.activeLanguage];
                content = `
                    <pre class="text-gray-800 bg-gray-100 p-4 rounded"><code>${solution.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                    <div class="p-4 border-t border-gray-200">
                        ${Button({ onClick: 'explainSolution()', children: 'AI Explain This Code', className: 'w-full' })}
                    </div>
                `;
            }

            return `
                <div class="absolute inset-0 bg-black bg-opacity-70 flex justify-center items-center z-40" onclick="hideSolution()">
                    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
                        <header class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800">${title}</h3>
                            <button onclick="hideSolution()" class="p-1 rounded-full hover:bg-gray-200"><div class="w-6 h-6 text-gray-600">${icons.x}</div></button>
                        </header>
                        <main class="overflow-auto">
                            ${content}
                        </main>
                    </div>
                </div>
            `;
        }

        function renderConfirmSolutionModal() {
            if (!state.showSolutionConfirm) return '';
            return `
                 <div class="absolute inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center animate-fade-in">
                        <h3 class="text-lg font-bold text-gray-800">Are you sure?</h3>
                        <p class="text-gray-600 my-4">Viewing the solution will reveal the answer. It's best to attempt the problem first!</p>
                        <div class="flex justify-center space-x-4">
                            ${Button({ onClick: 'hideSolutionConfirm()', variant: 'secondary', children: 'Cancel' })}
                            ${Button({ onClick: 'showSolution(true)', children: 'Show Solution' })}
                        </div>
                    </div>
                </div>
            `;
        }

        function PracticeModal() {
            if (!state.practiceModal.isOpen) return '';

            const { topic, round } = state.practiceModal;
            
            let content = '';
            switch (state.testState) {
                case 'setup':
                    content = renderModalSetup(topic, round);
                    break;
                case 'in_progress':
                    content = round === 'coding' ? renderModalCodingIDE() : renderModalAptitudeTest();
                    break;
                case 'results':
                    content = renderModalResults(round);
                    break;
            }

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-40 animate-fade-in">
                    <div id="practice-modal-content" class="bg-gray-100 rounded-lg shadow-2xl flex flex-col ${round === 'coding' && state.testState !== 'setup' ? 'w-full h-full max-w-7xl max-h-[95vh]' : 'w-full max-w-3xl max-h-[90vh]'}">
                        <header class="flex justify-between items-center p-4 border-b bg-white rounded-t-lg">
                            <h3 class="text-xl font-bold text-gray-800">Practice Zone: ${topic}</h3>
                            <button onclick="closePracticeModal()" class="p-2 rounded-full hover:bg-gray-200"><div class="w-6 h-6 text-gray-600">${icons.x}</div></button>
                        </header>
                        <main class="overflow-y-auto flex-grow relative">
                            ${content}
                            ${renderSuccessAnimation()}
                            ${round === 'coding' ? renderSolutionModal() : ''}
                            ${round === 'coding' ? renderConfirmSolutionModal() : ''}
                        </main>
                        ${(round !== 'coding' || state.testState === 'results') && !state.allTestsPassed ? `
                            <footer class="p-4 border-t bg-white rounded-b-lg">
                                ${state.testState === 'in_progress' ? Button({ onClick: 'handleNext()', disabled: state.currentSelection === null, children: state.currentIndex < state.questions.length - 1 ? 'Next Question' : 'Finish & See Results', className: 'w-full' }) : Button({ onClick: 'closePracticeModal()', variant: 'secondary', children: 'Close', className: 'w-full' })}
                            </footer>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function MockInterviewModal() {
            if (!state.mockInterviewModal.isOpen) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-40 animate-fade-in">
                    <div id="mock-interview-modal-content" class="bg-white rounded-lg shadow-2xl flex flex-col w-full max-w-2xl h-[90vh]">
                        <header class="flex justify-between items-center p-4 border-b">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center"><div class="w-6 h-6 mr-2">${icons.bot}</div> AI Mock Interview</h3>
                            <button onclick="closeMockInterviewModal()" class="p-2 rounded-full hover:bg-gray-200"><div class="w-6 h-6 text-gray-600">${icons.x}</div></button>
                        </header>
                        <main id="chat-container" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
                            ${state.interviewHistory.map(turn => `
                                <div class="flex ${turn.speaker === 'AI' ? 'justify-start' : 'justify-end'}">
                                    <div class="max-w-lg p-3 rounded-lg ${turn.speaker === 'AI' ? 'bg-indigo-100 text-indigo-900' : 'bg-blue-500 text-white'}">
                                        ${parseMarkdown(turn.text)}
                                    </div>
                                </div>
                            `).join('')}
                            ${state.isWaitingForAI ? `
                                <div class="flex justify-start">
                                    <div class="max-w-lg p-3 rounded-lg bg-indigo-100 text-indigo-900">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></div>
                                            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse ml-1 delay-75"></div>
                                            <div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse ml-1 delay-150"></div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </main>
                        <footer class="p-4 border-t bg-white">
                            <div class="flex items-center space-x-2">
                                <textarea id="user-interview-input" onkeydown="handleInterviewInputKey(event)" placeholder="Type your answer..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none" rows="2" ${state.isWaitingForAI ? 'disabled' : ''}>${state.userInterviewInput}</textarea>
                                ${Button({ onClick: 'sendInterviewResponse()', disabled: state.isWaitingForAI, children: `<div class="w-5 h-5">${icons.send}</div>`, className: '!px-3' })}
                            </div>
                        </footer>
                    </div>
                </div>
            `;
        }


        // --- Main Render Function ---
        function render() {
            const rounds = [
                { id: 'aptitude', name: 'Aptitude', icon: icons.brainCircuit }, { id: 'coding', name: 'Coding Round', icon: icons.code }, { id: 'gd', name: 'Group Discussion', icon: icons.users }, { id: 'tech1', name: 'Technical-1', icon: icons.cpu }, { id: 'tech2', name: 'Technical-2', icon: icons.cpu }, { id: 'hr', name: 'HR Round', icon: icons.userCheck }, { id: 'videos', name: 'Resource Videos', icon: icons.youtube },
            ];
            app.innerHTML = `<div class="min-h-screen font-sans"><header class="bg-white shadow-sm"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><div class="flex items-center"><div class="w-8 h-8 text-indigo-600">${icons.briefcase}</div><h1 class="ml-3 text-2xl font-bold text-gray-800">Interview Cracker AI</h1></div></div></header><main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><div class="bg-white p-6 rounded-lg shadow-lg mb-8 border-l-4 border-indigo-500"><h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><div class="w-6 h-6 mr-3 text-indigo-600">${icons.bot}</div>AI Prep Plan Generator</h2><p class="text-gray-600 mb-4">Paste a job description to generate a personalized preparation plan.</p><textarea id="job-description-textarea" placeholder="Paste job description here..." class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" ${state.isLoading ? 'disabled' : ''}>${state.jobDescription}</textarea>${Button({ onClick: 'handleGeneratePlan()', disabled: state.isLoading, children: state.isLoading ? `<span class="animate-spin mr-2 h-5 w-5">${icons.loader}</span>Generating...` : `<span class="w-5 h-5 mr-2">${icons.send}</span>Generate Plan`, className: 'w-full mt-4' })}</div><div class="mb-8" id="ai-plan-display">${AIPlanDisplay()}</div><div><h2 class="text-2xl font-bold text-gray-800 mb-4">General Interview Round Guides</h2><div class="lg:grid lg:grid-cols-12 lg:gap-8"><aside class="lg:col-span-3"><nav class="space-y-1">${rounds.map(round => `<button onclick="setState({ selectedRound: '${round.id}' })" class="w-full flex items-center px-3 py-3 text-sm font-medium rounded-md focus:outline-none ${state.selectedRound === round.id ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-200'}"><div class="w-5 h-5 mr-3">${round.icon}</div>${round.name}</button>`).join('')}</nav></aside><div class="mt-6 lg:mt-0 lg:col-span-9" id="round-content">${RoundContent()}</div></div></div></main><div id="modal-container">${PracticeModal()}${MockInterviewModal()}</div></div>`;
            
            const jobDescTextarea = document.getElementById('job-description-textarea');
            if (jobDescTextarea) {
                jobDescTextarea.addEventListener('input', (e) => { state.jobDescription = e.target.value; });
            }
            if (state.practiceModal.isOpen) {
                if (state.testState === 'in_progress' && state.practiceModal.round === 'coding') {
                    setupResizablePanes();
                    setupCodeEditor();
                }
                if (state.allTestsPassed) {
                    triggerConfetti();
                }
            }
            if(state.mockInterviewModal.isOpen && state.isWaitingForAI === false) {
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
            }
             // Add event listeners for new inputs
            const projectTitleInput = document.getElementById('projectTitle');
            if(projectTitleInput) {
                projectTitleInput.addEventListener('input', (e) => state.projectTitle = e.target.value);
            }
            const projectDescTextarea = document.getElementById('projectDesc');
            if(projectDescTextarea) {
                projectDescTextarea.addEventListener('input', (e) => state.projectDescription = e.target.value);
            }
            const userInterviewInput = document.getElementById('user-interview-input');
            if(userInterviewInput) {
                userInterviewInput.addEventListener('input', (e) => state.userInterviewInput = e.target.value);
            }
        }
        
        // --- Event Handlers & Logic ---
        window.setState = setState;
        window.handleGeneratePlan = handleGeneratePlan;
        window.handleGenerateProjectQA = handleGenerateProjectQA;
        
        window.handleStartPractice = (event, topic, round) => {
            event.stopPropagation();
            setState({
                practiceModal: { isOpen: true, topic, round },
                testState: 'setup',
                error: null,
                isLoading: false,
                numQuestions: round === 'coding' ? 1 : 5,
                timerDuration: 15,
                questions: [],
                userAnswers: [],
                currentIndex: 0,
                currentSelection: null,
                testResults: { passed: 0, failed: 0, cases: [] },
                allTestsPassed: false,
                aptitudeFeedback: null,
                isSolutionVisible: false,
                showSolutionConfirm: false,
                codeExplanation: null,
            });
        };

        window.startMockInterview = () => {
            setState({
                mockInterviewModal: { isOpen: true },
                interviewHistory: [{ speaker: 'AI', text: "Hello! I'm your AI interviewer. Let's begin. Tell me about yourself." }],
                isWaitingForAI: false,
                userInterviewInput: '',
            });
        };

        window.closeMockInterviewModal = () => {
            setState({ mockInterviewModal: { isOpen: false } });
        };

        window.sendInterviewResponse = () => {
            const userInput = document.getElementById('user-interview-input').value;
            if (!userInput.trim() || state.isWaitingForAI) return;
            state.interviewHistory.push({ speaker: 'User', text: userInput });
            setState({ userInterviewInput: '' }); // Clear state
            document.getElementById('user-interview-input').value = ''; // Clear textarea directly
            getNextInterviewResponse();
        };

        window.handleInterviewInputKey = (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendInterviewResponse();
            }
        };

        window.closePracticeModal = () => {
            clearInterval(timerInterval);
            setState({ practiceModal: { isOpen: false, topic: null, round: null }, timeLeft: null });
        };
        
        window.handleLanguageToggle = (lang) => {
            const newLangs = state.preferredLanguages.includes(lang) 
                ? state.preferredLanguages.filter(l => l !== lang) 
                : [...state.preferredLanguages, lang];
            if (newLangs.length > 0) {
                const newActiveLang = newLangs.includes(state.activeLanguage) ? state.activeLanguage : newLangs[0];
                setState({ preferredLanguages: newLangs, activeLanguage: newActiveLang });
            }
        };

        window.updatePracticeSetting = (key, value) => {
            let cleanValue = parseInt(value, 10);
            if (isNaN(cleanValue)) return;
            if (key === 'numQuestions') {
                cleanValue = Math.max(1, Math.min(10, cleanValue));
            } else {
                cleanValue = Math.max(1, cleanValue);
            }
            state[key] = cleanValue;
        };

        window.handleStartTest = async () => {
            setState({ isLoading: true, error: null });
            const { round, topic } = state.practiceModal;
            let prompt, schema;
            const languageSignatures = state.preferredLanguages.reduce((acc, lang) => ({ ...acc, [lang]: { type: "STRING" } }), {});

            if (round === 'coding') {
                prompt = `Generate a JSON array of ${state.numQuestions} unique, high-quality coding challenges on "${topic}". For 'problemStatement', use markdown with sections for "Problem Description", "Example Test Cases", "Constraints", and "Relevant Concepts". For all other text fields, use plain text. Include well-formatted, multi-line functionSignatures and solutions, and valid JSON testCases. Ensure the code is correctly indented.`;
                schema = { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, problemStatement: { type: "STRING" }, parameterDescription: { type: "STRING" }, constraints: { type: "ARRAY", items: { type: "STRING" } }, relevantTopics: { type: "ARRAY", items: { type: "STRING" } }, exampleTestCases: { type: "ARRAY", items: { type: "OBJECT", properties: { input: { type: "STRING" }, output: { type: "STRING" }, explanation: { type: "STRING" } } } }, functionSignatures: { type: "OBJECT", properties: languageSignatures }, testCases: { type: "ARRAY", items: { type: "OBJECT", properties: { input: { type: "STRING" }, expectedOutput: { type: "STRING" } } } }, solutions: { type: "OBJECT", properties: languageSignatures } }, required: ["title", "problemStatement", "functionSignatures", "testCases", "solutions", "exampleTestCases", "parameterDescription", "constraints", "relevantTopics"] } };
            } else {
                prompt = `Generate a JSON array of ${state.numQuestions} multiple-choice questions for an interview on "${topic}". Provide a detailed 'explanation' for each, using markdown for formatting (like bolding and lists).`;
                schema = { type: "ARRAY", items: { type: "OBJECT", properties: { question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct_answer_index: { type: "INTEGER" }, explanation: { type: "STRING" } }, required: ["question", "options", "correct_answer_index", "explanation"] } };
            }
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const text = await handleApiCall(apiUrl, payload, "Error fetching questions");
                const parsedJson = JSON.parse(text);
                
                const firstLang = state.preferredLanguages[0];
                setState({
                    questions: parsedJson,
                    userCode: round === 'coding' ? parsedJson[0].functionSignatures[firstLang] : '',
                    activeLanguage: firstLang,
                    timeLeft: state.timerDuration * 60,
                    testState: 'in_progress',
                    isLoading: false
                });
                startTimer();
            } catch (e) {
                setState({ error: `Failed to generate questions: ${e.message}`, isLoading: false });
            }
        };

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (state.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishTest();
                } else {
                    state.timeLeft -= 1;
                    const timerEl = document.querySelector('#ide-container .flex.items-center.space-x-4 > div');
                    if(timerEl) timerEl.innerHTML = `<div class="w-5 h-5 mr-2">${icons.clock}</div> ${formatTime(state.timeLeft)}`;
                }
            }, 1000);
        }
        
        const formatTime = (seconds) => {
            if (seconds === null) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        window.finishTest = () => {
            if (state.testState !== 'in_progress') return;
            clearInterval(timerInterval);
            if(state.practiceModal.round !== 'coding' && state.userAnswers.length > 0) {
                getAptitudeFeedback();
            }
            setState({ testState: 'results', timeLeft: null });
        };

        window.handlePrevious = () => {
            if (state.currentIndex > 0) {
                const prevIndex = state.currentIndex - 1;
                setState({
                    currentIndex: prevIndex,
                    userCode: state.questions[prevIndex].functionSignatures[state.activeLanguage],
                    testResults: { passed: 0, failed: 0, cases: [] },
                    allTestsPassed: false,
                });
            }
        };

        window.handleNext = () => {
            if (state.practiceModal.round !== 'coding') {
                const q = state.questions[state.currentIndex];
                const isCorrect = q.correct_answer_index === state.currentSelection;
                state.userAnswers.push({ question: q, answer: state.currentSelection, isCorrect });
                if (state.currentIndex < state.questions.length - 1) {
                    setState({ currentIndex: state.currentIndex + 1, currentSelection: null });
                } else {
                    finishTest();
                }
            } else {
                if (state.currentIndex < state.questions.length - 1) {
                    const nextIndex = state.currentIndex + 1;
                    setState({ 
                        currentIndex: nextIndex,
                        userCode: state.questions[nextIndex].functionSignatures[state.activeLanguage],
                        testResults: { passed: 0, failed: 0, cases: [] },
                        allTestsPassed: false
                    });
                } else {
                    finishTest();
                }
            }
        };
        
        window.setCurrentSelection = (index) => {
            setState({ currentSelection: index });
        };

        window.runCodeExecution = () => {
            if (state.isSubmitting) return;
            setState({ isSubmitting: true, testResults: { passed: 0, failed: 0, cases: [] } });
            
            setTimeout(() => {
                if (state.activeLanguage === 'javascript') {
                    runJsTestCases();
                } else {
                    simulateNonJsTestCases();
                }
            }, 500);
        };

        function runJsTestCases() {
            const problem = state.questions[state.currentIndex];
            const userCode = state.userCode;
            const casesToRun = problem.testCases;
            let passedCount = 0;
            const results = [];

            const funcNameMatch = problem.functionSignatures.javascript.match(/function\s+(\w+)/);
            if (!funcNameMatch) {
                results.push({ error: "Could not determine function name from signature." });
                setState({ testResults: { passed: 0, failed: casesToRun.length, cases: results }, isSubmitting: false });
                return;
            }
            const funcName = funcNameMatch[1];
            
            for (const tc of casesToRun) {
                try {
                    const userFunc = new Function(`${userCode}; return ${funcName};`)();
                    const params = JSON.parse(`[${tc.input}]`);
                    const actualOutput = userFunc(...params);
                    
                    const expectedOutput = JSON.parse(tc.expectedOutput);
                    const passed = JSON.stringify(actualOutput) === JSON.stringify(expectedOutput);

                    if (passed) passedCount++;
                    results.push({ ...tc, passed, actualOutput: JSON.stringify(actualOutput) });

                } catch (e) {
                    results.push({ ...tc, passed: false, actualOutput: `Error: ${e.message}` });
                }
            }
            
            const allPassed = passedCount === casesToRun.length;
            if (allPassed) {
                setTimeout(() => handleNext(), 3000);
            }
            setState({
                testResults: { passed: passedCount, failed: casesToRun.length - passedCount, cases: results },
                isSubmitting: false,
                allTestsPassed: allPassed
            });
        }

        function simulateNonJsTestCases() {
            const problem = state.questions[state.currentIndex];
            const userCode = state.userCode;
            const solutionCode = problem.solutions[state.activeLanguage];
            const signatureCode = problem.functionSignatures[state.activeLanguage];

            const cleanUserCode = userCode.replace(/\s/g, '');
            const cleanSolutionCode = solutionCode.replace(/\s/g, '');
            const cleanSignatureCode = signatureCode.replace(/\s/g, '');

            let passRate = 0;
            if (cleanUserCode.length > cleanSignatureCode.length + 5) {
                if (cleanUserCode === cleanSolutionCode) {
                    passRate = 1;
                } else {
                    let matchingChars = 0;
                    for (let i = 0; i < cleanUserCode.length; i++) {
                        if (i < cleanSolutionCode.length && cleanUserCode[i] === cleanSolutionCode[i]) {
                            matchingChars++;
                        }
                    }
                    passRate = (matchingChars / cleanSolutionCode.length) * 0.85;
                }
            }

            const casesToRun = problem.testCases;
            let passedCount = 0;
            const results = casesToRun.map((tc, index) => {
                const shouldPass = (index + 1) / casesToRun.length <= passRate;
                if (shouldPass) {
                    passedCount++;
                    return { ...tc, passed: true, actualOutput: tc.expectedOutput };
                } else {
                    let wrongOutput = "null";
                     try {
                        const expected = JSON.parse(tc.expectedOutput);
                        if (typeof expected === 'number') wrongOutput = expected + 1;
                        else if (Array.isArray(expected)) wrongOutput = JSON.stringify(expected.slice(0, 1));
                    } catch(e) {
                        wrongOutput = tc.expectedOutput.split('').reverse().join('');
                    }
                    return { ...tc, passed: false, actualOutput: wrongOutput };
                }
            });
            
            const allPassed = passedCount === casesToRun.length;
             if (allPassed) {
                setTimeout(() => handleNext(), 3000);
            }
            setState({
                testResults: { passed: passedCount, failed: casesToRun.length - passedCount, cases: results },
                isSubmitting: false,
                allTestsPassed: allPassed
            });
        }
        
        window.toggleFullscreen = () => setState({ isFullscreen: !state.isFullscreen });
        window.confirmShowSolution = () => setState({ showSolutionConfirm: true });
        window.hideSolutionConfirm = () => setState({ showSolutionConfirm: false });
        window.showSolution = (confirmed = false) => {
            if (!confirmed) {
                confirmShowSolution();
                return;
            }
            setState({ isSolutionVisible: true, showSolutionConfirm: false, codeExplanation: null });
        };
        window.hideSolution = () => setState({ isSolutionVisible: false, codeExplanation: null });
        window.explainSolution = () => {
            getCodeExplanation();
        };

        function setupResizablePanes() {
             const handle = document.getElementById('resize-handle');
            const container = document.getElementById('resizable-container');
            const leftPane = document.getElementById('problem-pane');
            if (!handle || !container || !leftPane) return;

            let isDragging = false;
            handle.addEventListener('mousedown', (e) => { isDragging = true; e.preventDefault(); });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const containerRect = container.getBoundingClientRect();
                let newLeftWidth = e.clientX - containerRect.left;
                if (newLeftWidth < 200) newLeftWidth = 200;
                if (newLeftWidth > containerRect.width - 200) newLeftWidth = containerRect.width - 200;
                leftPane.style.width = `${newLeftWidth}px`;
            });
            document.addEventListener('mouseup', () => { isDragging = false; });
        }

        function setupCodeEditor() {
            const editor = document.getElementById('code-editor');
            if (!editor) return;
            
            editor.addEventListener('input', (e) => { state.userCode = e.target.value; });
            
            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const { selectionStart, selectionEnd, value } = e.target;
                    e.target.value = value.substring(0, selectionStart) + '  ' + value.substring(selectionEnd);
                    e.target.selectionStart = e.target.selectionEnd = selectionStart + 2;
                }
            });

            const langSelect = document.getElementById('language-select');
            langSelect.addEventListener('change', (e) => {
                const newLang = e.target.value;
                const problem = state.questions[state.currentIndex];
                setState({ activeLanguage: newLang, userCode: problem.functionSignatures[newLang] });
            });
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // --- Initial Render ---
        render();

    </script>
</body>
</html>
